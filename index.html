<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <title>Residential Breaker Panel Editor</title>
  <style>
  :root{
    --outer-bg:#f9f9f9;
    --card-bg:#ffffff;
    --panel-bg:#eeeeee;
    --panel-border:#cccccc;
    --slot-bg:#cccccc;
    --slot-border:#999999;
    --main-breaker:#990000;
    --text:#111;
    --muted:#555;
    --shadow:0 8px 20px rgba(0,0,0,.08);
  }

  body { 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
    background: var(--outer-bg);
    padding: 20px; 
    color: var(--text);
  }
  h1 { 
    text-align: center; 
    margin-bottom: 16px;
  }

  /* Export container wraps header + panel + footer so PNG includes everything */
  #export-container{
    width: min(860px, 95vw);
    margin: 0 auto;
    background: var(--card-bg);
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 18px 22px 22px;
  }

  /* Header & Footer container blocks */
  .info-block {
    display: grid;
    gap: 8px 16px;
    align-items: center;
    margin-left: 50px;   /* aligns with panel padding */
    margin-right: 50px;  /* keeps text edges flush with panel grid */
  }

  .info-header {
    grid-template-columns: 1fr auto;
    margin-bottom: 12px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }

  .info-footer {
    grid-template-columns: 1fr;
    margin-top: 14px;
    border-top: 2px solid #eee;
    padding-top: 12px;
  }

  .info-title{
    font-weight: 700;
    font-size: 18px;
  }

  .display-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 20px;
    margin: 6px 0;
    font-size: 14px;
  }

  .display-row.full {
    grid-template-columns: 1fr; /* full-width row (e.g., Location, Notes) */
  }

  /* Default two-column cells (label + value) */
  .display-row .cell {
    display: grid;
    grid-template-columns: 110px 1fr; /* fixed label column + flexible value */
    align-items: start;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.4; /* better readability */
  }

  /* Full-width rows behave like blocks */
  .display-row.full .cell {
    display: block;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.5; /* extra line spacing for longer text like Notes */
  }

  .display-row .cell strong {
    min-width: 110px;
    margin-right: 6px;
  }

  .edit-only{ display: inline-flex; gap: 8px; }
  .edit-only button{
    padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd;
    cursor: pointer; background:#fafafa;
  }
  .edit-only button:hover{ background:#f0f0f0; }

  /* During export we hide edit-only UI and show display-only text (it‚Äôs already visible by default) */
  body.exporting .edit-only{ display:none !important; }

  #panel-container {
    display: flex; 
    flex-direction: column; 
    align-items: center;
    margin: 8px 0 6px;
  }

  .main-breaker-slot {
    grid-column: 1 / span 2;
    height: 60px;
    background: var(--main-breaker);
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    line-height: 1.2;
    border-radius: 6px;
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    user-select: none;
  }

  #panel {
    display: grid;
    grid-template-columns: repeat(2, 180px);
    grid-auto-rows: 66px;
    gap: 4px 30px;
    background: var(--panel-bg);
    padding: 20px 50px;     /* extra horizontal padding to show outer numbers */
    border: 2px solid var(--panel-border);
    border-radius: 10px;
    position: relative;
  }

  .slot {
    background: var(--slot-bg); 
    border: 1px dashed var(--slot-border); 
    border-radius: 5px;
    position: relative; 
    cursor: pointer; 
    padding-top: 0;
    overflow: visible;   /* allow outside slot-number to show */
  }

  .slot-number {
    position: absolute; 
    top: 50%; 
    transform: translateY(-50%);
    font-size: 20px; 
    font-weight: bold; 
    color: #aaa; 
    user-select: none;
    text-shadow: 1px 1px 0 #fff, -1px -1px 0 #999;
    pointer-events: none;
  }
  .slot-number.left { left: -32px; text-align: right; }
  .slot-number.right{ right: -32px; text-align: left; }

  .breaker {
    position: absolute; 
    top: 0; left: 0; right: 0; bottom: 0;
    background: #444; 
    color: #fff; 
    display: flex;
    flex-direction: column; 
    justify-content: left; 
    align-items: left;
    font-size: 12px; 
    border-radius: 5px; 
    padding: 2px 6px; 
    box-sizing: border-box;
  }

  .breaker-type-label {
    position: absolute; 
    bottom: 3px; 
    right: 5px;
    font-size: 10px; 
    font-weight: bold; 
    padding: 0 3px; 
    border-radius: 3px;
    color: white; 
    user-select: none;
  }

  /* Type colors */
  .type-Standard { background-color: cyan; color: black; }
  .type-GFCI     { background-color: limegreen; }
  .type-AFCI     { background-color: #888; }         /* medium gray */
  .type-Dual     { background-color: magenta; }
  .type-CAFI     { background-color: #fff; color: #000; }
  .type-Tandem   { background-color: orange; }
  .type-Surge    { background-color: blue; }

  .toolbar { 
    margin: 14px auto 8px; 
    text-align: center; 
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .toolbar button { 
    padding: 8px 14px; 
    margin: 0; 
    cursor: pointer; 
    border-radius: 8px;
    border: 1px solid #ddd;
    background:#fff;
  }
  .toolbar button:hover{ background:#f4f4f4; }

  #autosaveTimer { 
    margin-top: 8px; 
    text-align: center; 
    font-style: italic; 
    color: var(--muted); 
  }

  dialog { 
    border: none; 
    border-radius: 10px; 
    padding: 20px; 
    width: 360px; 
    box-shadow: var(--shadow);
  }
  dialog h3{ margin: 0 0 10px; }
  dialog label { 
    display: block; 
    margin-top: 10px; 
    font-size: 13px;
  }
  dialog input, dialog select, dialog textarea { 
    width: 100%; 
    padding: 6px 8px; 
    margin-top: 5px; 
    border-radius: 6px;
    border: 1px solid #ccc;
    font: inherit;
  }
  dialog textarea{ min-height: 70px; resize: vertical; }
  dialog .buttons { 
    margin-top: 20px; 
    text-align: right; 
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  dialog .buttons button{
    padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background:#fff; cursor:pointer;
  }
  dialog .buttons button:hover{ background:#f4f4f4; }
  </style>
</head>
<body>
  <h1>Residential Breaker Panel Editor</h1>

  <div id="export-container">
    <!-- Header (display text + edit button; inputs live in a dialog) -->
    <section class="info-block info-header" id="headerBlock">
      <div class="info-title">Panel Information</div>
      <div class="edit-only">
        <button type="button" onclick="openHeaderDialog()">‚úèÔ∏è Edit Header</button>
      </div>

      <div class="display-row">
        <div class="cell"><strong>Address:</strong> <span id="hdrAddress_out">‚Äî</span></div>
        <div class="cell"><strong>Install Date:</strong> <span id="hdrInstall_out">‚Äî</span></div>
      </div>
	  <div class="display-row full">
	    <div class="cell"><strong>Location:</strong> <span id="hdrLocation_out">‚Äî</span></div>
	  </div>
    </section>

    <div id="panel-container">
      <div id="panel"><div id="main-breaker" class="main-breaker-slot" title="Click to edit main disconnect">
        <span>Main Disconnect</span>
        <span id="main-amps">200A</span>
      </div><div class="slot" data-index="0"><div class="slot-number left">1</div></div><div class="slot" data-index="1"><div class="slot-number right">2</div></div><div class="slot" data-index="2"><div class="slot-number left">3</div></div><div class="slot" data-index="3"><div class="slot-number right">4</div></div><div class="slot" data-index="4"><div class="slot-number left">5</div></div><div class="slot" data-index="5"><div class="slot-number right">6</div></div><div class="slot" data-index="6"><div class="slot-number left">7</div></div><div class="slot" data-index="7"><div class="slot-number right">8</div></div><div class="slot" data-index="8"><div class="slot-number left">9</div></div><div class="slot" data-index="9"><div class="slot-number right">10</div></div><div class="slot" data-index="10"><div class="slot-number left">11</div></div><div class="slot" data-index="11"><div class="slot-number right">12</div></div><div class="slot" data-index="12"><div class="slot-number left">13</div></div><div class="slot" data-index="13"><div class="slot-number right">14</div></div><div class="slot" data-index="14"><div class="slot-number left">15</div></div><div class="slot" data-index="15"><div class="slot-number right">16</div></div><div class="slot" data-index="16"><div class="slot-number left">17</div></div><div class="slot" data-index="17"><div class="slot-number right">18</div></div><div class="slot" data-index="18"><div class="slot-number left">19</div></div><div class="slot" data-index="19"><div class="slot-number right">20</div></div></div>
    </div>

    <!-- Footer (display text + edit button; inputs live in a dialog) -->
    <section class="info-block info-footer" id="footerBlock">
      <div class="display-row">
        <div class="cell"><strong>Manufacturer:</strong> <span id="ftrMfr_out">‚Äî</span></div>
        <div class="cell"><strong>Model:</strong> <span id="ftrModel_out">‚Äî</span></div>
      </div>
      <div class="display-row">
        <div class="cell"><strong>Panel Rating:</strong> <span id="ftrRating_out">‚Äî</span></div>
        <div class="cell"><strong>Voltage:</strong> <span id="ftrVoltage_out">‚Äî</span></div>
      </div>
	  <!-- Installed By gets its own row, still two columns -->
	  <div class="display-row">
	    <div class="cell"><strong>Installed By:</strong> <span id="ftrInstaller_out">‚Äî</span></div>
	    <div class="cell"></div>
	  </div>
      <!-- Notes gets a full-width row -->
	  <div class="display-row full">
	    <div class="cell"><strong>Notes:</strong> <span id="ftrNotes_out">‚Äî</span></div>
	  </div>
      <div class="edit-only" style="margin-top:6px;">
        <button type="button" onclick="openFooterDialog()">‚úèÔ∏è Edit Footer</button>
      </div>
    </section>
  </div>

  <div class="toolbar">
    <button onclick="addRow()">‚ûï Add Row</button>
    <button onclick="clearPanel()">üßπ Clear</button>
    <button onclick="loadPanel()">üìÇ Load Panel</button>
    <button onclick="exportPanelJSON()">üíæ Export Panel JSON</button>
    <button onclick="importPanelJSON()">üì• Import Panel JSON</button>
    <button onclick="clearSavedPanel()">‚ùå Clear Saved Panel</button>
    <button onclick="exportPanelPNG()">üñºÔ∏è Export Panel PNG</button>
    <button onclick="savePanel()">üíæ Save Panel</button>
  </div>
  <div id="autosaveTimer">No changes pending.</div>

  <!-- Breaker Config Dialog -->
  <dialog id="breakerDialog">
    <form method="dialog">
      <h3>Configure Breaker</h3>
      <label>Label: <input type="text" id="breakerLabel" required=""></label>
      <label>Amperage: <input type="number" id="breakerAmps" min="15" step="5" value="15"></label>
      <label>Type:
        <select id="breakerType">
          <option value="Standard" selected="selected">Standard</option>
          <option value="GFCI">GFCI</option>
          <option value="AFCI">AFCI</option>
          <option value="Dual">DUAL</option>
          <option value="CAFI">CAFI</option>
          <option value="Tandem">Tandem</option>
          <option value="Surge">Surge</option>
        </select>
      </label>
      <label>Poles:
        <select id="breakerPoles">
          <option value="1" selected="selected">1-Pole</option>
          <option value="2">2-Pole</option>
        </select>
      </label>
      <div class="buttons">
        <button type="submit">OK</button>
        <button type="button" onclick="deleteBreaker()">Delete</button>
        <button type="button" onclick="breakerDialog.close()">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Main Disconnect Dialog -->
  <dialog id="mainDialog">
    <form method="dialog">
      <h3>Main Disconnect</h3>
      <label>Amperage: <input type="number" id="mainAmperage" value="200" min="100" step="25"></label>
      <div class="buttons"><button type="submit">OK</button></div>
    </form>
  </dialog>

  <!-- Header Dialog -->
  <dialog id="headerDialog">
    <form method="dialog">
      <h3>Edit Header</h3>
      <label>Address <input type="text" id="hdrAddress_in" placeholder="123 Main St, City, ST 00000"></label>
      <label>Install Date <input type="date" id="hdrInstall_in"></label>
      <label>Location <input type="text" id="hdrLocation_in" placeholder="Garage / Basement / Outdoor"></label>
      <div class="buttons">
        <button type="submit">Save</button>
        <button type="button" onclick="headerDialog.close()">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Footer Dialog -->
  <dialog id="footerDialog">
    <form method="dialog">
      <h3>Edit Footer</h3>
      <label>Manufacturer <input type="text" id="ftrMfr_in" placeholder="Square D"></label>
      <label>Model <input type="text" id="ftrModel_in" placeholder="QOOO1A200PC"></label>
      <label>Panel Rating (e.g. 200A) <input type="text" id="ftrRating_in" placeholder="200A"></label>
      <label>Voltage (e.g. 120/240V) <input type="text" id="ftrVoltage_in" placeholder="120/240V"></label>
      <label>Installed By <input type="text" id="ftrInstaller_in" placeholder="Some Guys Electrical"></label>
      <label>Notes <textarea id="ftrNotes_in" placeholder="Outdoor rated, GFCI at feeder"></textarea></label>
      <div class="buttons">
        <button type="submit">Save</button>
        <button type="button" onclick="footerDialog.close()">Cancel</button>
      </div>
    </form>
  </dialog>

  <script src="index_files/html2canvas.min.js"></script>
  <label>¬© 2026 Chris Boatwright ¬∑ MIT License</label>
  <script>
    const panel = document.getElementById("panel");
    const breakerDialog = document.getElementById("breakerDialog");
    const mainDialog = document.getElementById("mainDialog");
    const headerDialog = document.getElementById("headerDialog");
    const footerDialog = document.getElementById("footerDialog");
    const autosaveTimerElem = document.getElementById("autosaveTimer");
    const NUM_INITIAL_ROWS = 10;

    let selectedSlotIndex = null;
    let autosaveSecondsLeft = 30;
    let autosaveInterval = null;
    let changesMade = false;

    /* ----------------- Header/Footer state & helpers ----------------- */
    const headerState = {
      address: "",
      installDate: "",
      location: ""
    };
    const footerState = {
      manufacturer: "",
      model: "",
      rating: "",
      voltage: "",
      installer: "",
      notes: ""
    };

    function openHeaderDialog(){
      document.getElementById("hdrAddress_in").value = headerState.address || "";
      document.getElementById("hdrInstall_in").value = headerState.installDate || "";
      document.getElementById("hdrLocation_in").value = headerState.location || "";
      headerDialog.returnValue = "";
      headerDialog.showModal();
    }
    headerDialog.querySelector("form").addEventListener("submit", e=>{
      e.preventDefault();
      headerState.address = document.getElementById("hdrAddress_in").value.trim();
      headerState.installDate = document.getElementById("hdrInstall_in").value;
      headerState.location = document.getElementById("hdrLocation_in").value.trim();
      updateHeaderDisplay();
      headerDialog.close("ok");
      markChanges();
    });

    function openFooterDialog(){
      document.getElementById("ftrMfr_in").value = footerState.manufacturer || "";
      document.getElementById("ftrModel_in").value = footerState.model || "";
      document.getElementById("ftrRating_in").value = footerState.rating || "";
      document.getElementById("ftrVoltage_in").value = footerState.voltage || "";
      document.getElementById("ftrInstaller_in").value = footerState.installer || "";
      document.getElementById("ftrNotes_in").value = footerState.notes || "";
      footerDialog.returnValue = "";
      footerDialog.showModal();
    }
    footerDialog.querySelector("form").addEventListener("submit", e=>{
      e.preventDefault();
      footerState.manufacturer = document.getElementById("ftrMfr_in").value.trim();
      footerState.model = document.getElementById("ftrModel_in").value.trim();
      footerState.rating = document.getElementById("ftrRating_in").value.trim();
      footerState.voltage = document.getElementById("ftrVoltage_in").value.trim();
      footerState.installer = document.getElementById("ftrInstaller_in").value.trim();
      footerState.notes = document.getElementById("ftrNotes_in").value.trim();
      updateFooterDisplay();
      footerDialog.close("ok");
      markChanges();
    });

    function updateHeaderDisplay(){
      document.getElementById("hdrAddress_out").innerText = headerState.address || "‚Äî";
      // Format install date nicely if present
      const d = headerState.installDate ? new Date(headerState.installDate) : null;
      document.getElementById("hdrInstall_out").innerText = d && !isNaN(d) ? d.toLocaleDateString() : "‚Äî";
      document.getElementById("hdrLocation_out").innerText = headerState.location || "‚Äî";
    }
    function updateFooterDisplay(){
      document.getElementById("ftrMfr_out").innerText = footerState.manufacturer || "‚Äî";
      document.getElementById("ftrModel_out").innerText = footerState.model || "‚Äî";
      document.getElementById("ftrRating_out").innerText = footerState.rating || "‚Äî";
      document.getElementById("ftrVoltage_out").innerText = footerState.voltage || "‚Äî";
      document.getElementById("ftrInstaller_out").innerText = footerState.installer || "‚Äî";
      document.getElementById("ftrNotes_out").innerText = footerState.notes || "‚Äî";
    }

    /* ----------------- Helpers ----------------- */

    function renderSlotNumber(slot, i) {
      const num = document.createElement("div");
      num.className = "slot-number " + (i % 2 === 0 ? "left" : "right");
      num.textContent = i + 1;
      slot.appendChild(num);
    }

    function createSlot(i) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.dataset.index = i;
      slot.onclick = () => openBreakerDialog(i);
      renderSlotNumber(slot, i);
      return slot;
    }

    // Find a slot element by its logical index (ignores the main breaker row)
    function getSlotEl(i) {
      return panel.querySelector('.slot[data-index="' + i + '"]');
    }

    function getNextSlotEl(i) {
      return getSlotEl(i + 2);
    }

    function restoreInteractiveSlot(slot, index) {
      slot.style.pointerEvents = "auto";
      slot.onclick = () => openBreakerDialog(index);
      slot.innerHTML = "";
      renderSlotNumber(slot, index);
    }

    /* ----------------- Panel build ----------------- */

    function createPanel(rows = NUM_INITIAL_ROWS) {
      panel.innerHTML = "";

      // Main breaker row first (spans both columns)
      const mainBreaker = document.createElement("div");
      mainBreaker.id = "main-breaker";
      mainBreaker.className = "main-breaker-slot";
      mainBreaker.title = "Click to edit main disconnect";
      mainBreaker.innerHTML = `
        <span>Main Disconnect</span>
        <span id="main-amps">200A</span>
      `;
      mainBreaker.onclick = () => mainDialog.showModal();
      panel.appendChild(mainBreaker);

      // Then the slots
      for (let i = 0; i < rows * 2; i++) {
        panel.appendChild(createSlot(i));
      }
    }
    createPanel();

    function addRow() {
      // Append two new slots with correct logical indices
      const currentSlots = panel.querySelectorAll(".slot").length;
      panel.appendChild(createSlot(currentSlots));
      panel.appendChild(createSlot(currentSlots + 1));
      markChanges();
    }

    function clearPanel() {
      if (confirm("Clear all breakers?")) {
        createPanel();
        markChanges();
      }
    }

    mainDialog.addEventListener("close", () => {
      const amps = document.getElementById("mainAmperage").value;
      const mainAmpsEl = document.getElementById("main-amps");
      if (mainAmpsEl) mainAmpsEl.innerText = amps + "A";
      markChanges();
    });

    /* ----------------- Dialog Open ----------------- */

    function openBreakerDialog(i) {
      selectedSlotIndex = i;
      const slot = getSlotEl(i);
      const br = slot ? slot.querySelector(".breaker") : null;

      if (br) {
        const lines = br.innerText.split("\n");
        document.getElementById("breakerLabel").value = lines[0] || "";

        const ampsMatch = lines[1]?.match(/^(\d+)(A)?/);
        document.getElementById("breakerAmps").value = ampsMatch?.[1] || 15;

        // Determine type from badge (more reliable than text line)
        const badge = br.querySelector(".breaker-type-label");
        let detectedType = "Standard";
        if (badge) {
          const t = badge.textContent.trim().toUpperCase();
          if (t === "STD.") detectedType = "Standard";
          else if (t === "GFCI") detectedType = "GFCI";
          else if (t === "AFCI") detectedType = "AFCI";
          else if (t === "DUAL") detectedType = "Dual";
          else if (t === "CAFI") detectedType = "CAFI";
          else if (t === "TAND" || t === "TANDEM") detectedType = "Tandem";
          else if (t === "SURGE") detectedType = "Surge";
        }
        document.getElementById("breakerType").value = detectedType;

        // Poles check (look two slots below for same label)
        const nextSlot = getNextSlotEl(i);
        const isTwoPole =
          nextSlot &&
          nextSlot.querySelector(".breaker") &&
          nextSlot.querySelector(".breaker").children[0].innerText === br.children[0].innerText;

        document.getElementById("breakerPoles").value = isTwoPole ? "2" : "1";
      } else {
        document.getElementById("breakerLabel").value = "";
        document.getElementById("breakerAmps").value = 15;
        document.getElementById("breakerType").value = "Standard";
        document.getElementById("breakerPoles").value = "1";
      }

      breakerDialog.returnValue = "";
      breakerDialog.showModal();
    }

    /* ----------------- Dialog Submit (Create/Update) ----------------- */

    breakerDialog.querySelector("form").addEventListener("submit", e => {
      e.preventDefault();
      breakerDialog.returnValue = "ok";
      breakerDialog.close("ok");
    });

    breakerDialog.addEventListener("close", () => {
      if (breakerDialog.returnValue !== "ok") return;

      const label = document.getElementById("breakerLabel").value.trim();
      const amps = document.getElementById("breakerAmps").value;
      const type = document.getElementById("breakerType").value;
      const poles = parseInt(document.getElementById("breakerPoles").value, 10);

      if (!label) {
        alert("Label cannot be empty!");
        return;
      }

      const slot = getSlotEl(selectedSlotIndex);
      const nextSlot = getNextSlotEl(selectedSlotIndex);

      // If previously 2-pole and now switching to 1, clean up subordinate if it exists
      if (nextSlot && nextSlot.style.pointerEvents === "none" && poles === 1) {
        restoreInteractiveSlot(nextSlot, selectedSlotIndex + 2);
      }

      if (poles === 2) {
        if (!nextSlot) {
          alert("Cannot place 2-pole breaker at bottom of panel.");
          return;
        }
        if (nextSlot.querySelector(".breaker")) {
          if (!confirm("Second slot is occupied. Delete it?")) return;
          restoreInteractiveSlot(nextSlot, selectedSlotIndex + 2);
        }
      }

      // Clear and restore slot chrome
      slot.innerHTML = "";
      renderSlotNumber(slot, selectedSlotIndex);

      if (poles === 2 && nextSlot) {
        nextSlot.innerHTML = "";
        renderSlotNumber(nextSlot, selectedSlotIndex + 2);
      }

      // Build primary breaker
      const br = document.createElement("div");
      br.className = "breaker";
      br.title = `${label}\n${amps}A\n${type}\n${poles}-Pole`;
      br.innerHTML = `<div>${label}</div><div>${amps}A</div>`;

      const typeLabel = document.createElement("div");
      typeLabel.className = "breaker-type-label type-" + type;
      typeLabel.textContent =
        type === "Standard" ? "STD."
        : type === "Tandem" ? "TAND"
        : type.toUpperCase();
      br.appendChild(typeLabel);

      slot.appendChild(br);

      // Build subordinate for 2-pole
      if (poles === 2 && nextSlot) {
        const clone = br.cloneNode(true);
        clone.removeAttribute("style");
        clone.style.background = "#777";
        clone.style.color = "#ddd";
        clone.style.pointerEvents = "none";

        const oldLabel = clone.querySelector(".breaker-type-label");
        if (oldLabel) oldLabel.remove();
        const cloneTypeLabel = document.createElement("div");
        cloneTypeLabel.className = "breaker-type-label type-" + type;
        cloneTypeLabel.textContent =
          type === "Standard" ? "STD."
          : type === "Tandem" ? "TAND"
          : type.toUpperCase();
        clone.appendChild(cloneTypeLabel);

        nextSlot.appendChild(clone);
        nextSlot.onclick = null;
        nextSlot.style.pointerEvents = "none";
      }

      markChanges();
    });

    /* ----------------- Delete Breaker ----------------- */

    function deleteBreaker() {
      if (selectedSlotIndex === null) return;

      const slot = getSlotEl(selectedSlotIndex);
      if (!slot) return;

      const br = slot.querySelector(".breaker");
      if (!br) return;

      const nextSlot = getNextSlotEl(selectedSlotIndex);
      const prevSlot = getSlotEl(selectedSlotIndex - 2);

      const isTwoPoleTop =
        nextSlot && nextSlot.querySelector(".breaker") &&
        nextSlot.querySelector(".breaker").children[0].innerText === br.children[0].innerText;

      const isTwoPoleBottom =
        prevSlot && prevSlot.querySelector(".breaker") &&
        prevSlot.querySelector(".breaker").children[0].innerText === br.children[0].innerText;

      slot.innerHTML = "";
      renderSlotNumber(slot, selectedSlotIndex);

      if (isTwoPoleTop) {
        restoreInteractiveSlot(nextSlot, selectedSlotIndex + 2);
      }

      if (isTwoPoleBottom) {
        restoreInteractiveSlot(prevSlot, selectedSlotIndex - 2);
      }

      breakerDialog.close();
      markChanges();
    }

    /* ----------------- Autosave ----------------- */

    function markChanges() {
      changesMade = true;
      if (!autosaveInterval) startAutosaveTimer();
    }

    function startAutosaveTimer() {
      autosaveSecondsLeft = 30;
      updateAutosaveText();
      autosaveInterval = setInterval(() => {
        autosaveSecondsLeft--;
        updateAutosaveText();
        if (autosaveSecondsLeft <= 0) {
          if (changesMade) savePanel(true); // silent save
          clearInterval(autosaveInterval);
          autosaveInterval = null;
        }
      }, 1000);
    }

    function updateAutosaveText() {
      autosaveTimerElem.innerText = changesMade
        ? `Auto-saving in ${autosaveSecondsLeft} seconds...`
        : "No changes pending.";
    }

    /* ----------------- Save/Load/Import/Export ----------------- */

    function savePanel(silent = false) {
      const data = [];
      const slots = panel.querySelectorAll(".slot");

      slots.forEach(slot => {
        const i = parseInt(slot.dataset.index, 10);
        const br = slot.querySelector(".breaker");
        if (!br) return;

        const label = br.children[0].innerText;
        const ampsMatch = br.children[1].innerText.match(/^(\d+)A/);
        const amps = ampsMatch ? parseInt(ampsMatch[1], 10) : 15;

        // Type from badge
        const badge = br.querySelector(".breaker-type-label");
        let type = "Standard";
        if (badge) {
          const t = badge.textContent.trim().toUpperCase();
          if (t === "STD.") type = "Standard";
          else if (t === "GFCI") type = "GFCI";
          else if (t === "AFCI") type = "AFCI";
          else if (t === "DUAL") type = "Dual";
          else if (t === "CAFI") type = "CAFI";
          else if (t === "TAND" || t === "TANDEM") type = "Tandem"; // accept both
          else if (t === "SURGE") type = "Surge";
        }

        const nextSlot = getNextSlotEl(i);
        const poles =
          nextSlot &&
          nextSlot.querySelector(".breaker") &&
          nextSlot.querySelector(".breaker").children[0].innerText === label
            ? 2
            : 1;

        // Skip subordinate breaker (second half of a 2-pole pair)
        const prevSlot = getSlotEl(i - 2);
        if (
          prevSlot &&
          prevSlot.querySelector(".breaker") &&
          prevSlot.querySelector(".breaker").children[0].innerText === label
        ) {
          return;
        }

        data.push({ index: i, label, amps, type, poles });
      });

      const mainAmpsEl = document.getElementById("main-amps");
      const mainAmps = mainAmpsEl ? parseInt(mainAmpsEl.innerText.replace("A", ""), 10) : 200;

      const payload = {
        version: 2,
        mainAmps,
        header: { ...headerState },
        footer: { ...footerState },
        breakers: data
      };

      localStorage.setItem("breakerPanelData", JSON.stringify(payload));
      changesMade = false;

      if (!silent) alert("Panel saved!");
      autosaveSecondsLeft = 30;
      updateAutosaveText();
    }

    function loadPanel() {
      const saved = localStorage.getItem("breakerPanelData");
      if (!saved) {
        alert("No saved panel found.");
        return;
      }
      const data = JSON.parse(saved);

      const version = data.version || 1;

      // Build enough slots first, then set main amps
      const rowsNeeded = Math.max(NUM_INITIAL_ROWS, Math.ceil((data.breakers?.length || 0) / 2) + 2);
      createPanel(rowsNeeded);

      const mainAmpsEl = document.getElementById("main-amps");
      if (mainAmpsEl) mainAmpsEl.innerText = (data.mainAmps || 200) + "A";

      // Restore header/footer if present (v2+)
      if (version >= 2 && data.header) {
        headerState.address = data.header.address || "";
        headerState.installDate = data.header.installDate || "";
        headerState.location = data.header.location || "";
      }
      if (version >= 2 && data.footer) {
        footerState.manufacturer = data.footer.manufacturer || "";
        footerState.model = data.footer.model || "";
        footerState.rating = data.footer.rating || "";
        footerState.voltage = data.footer.voltage || "";
        footerState.installer = data.footer.installer || "";
        footerState.notes = data.footer.notes || "";
      }
      updateHeaderDisplay();
      updateFooterDisplay();

      for (let b of (data.breakers || [])) {
        const slot = getSlotEl(b.index);
        if (!slot) continue;

        slot.innerHTML = "";
        renderSlotNumber(slot, b.index);

        const br = document.createElement("div");
        br.className = "breaker";
        br.title = `${b.label}\n${b.amps}A\n${b.type}\n${b.poles}-Pole`;
        br.innerHTML = `<div>${b.label}</div><div>${b.amps}A</div>`;

        const typeLabel = document.createElement("div");
        typeLabel.className = "breaker-type-label type-" + b.type;
        typeLabel.textContent =
          b.type === "Standard" ? "STD."
          : b.type === "Tandem" ? "TAND"
          : String(b.type).toUpperCase();
        br.appendChild(typeLabel);

        slot.appendChild(br);

        if (b.poles === 2) {
          const ns = getNextSlotEl(b.index);
          if (ns) {
            ns.innerHTML = "";
            renderSlotNumber(ns, b.index + 2);

            const clone = br.cloneNode(true);
            clone.removeAttribute("style");
            clone.style.background = "#777";
            clone.style.color = "#ddd";
            clone.style.pointerEvents = "none";

            const oldLabel = clone.querySelector(".breaker-type-label");
            if (oldLabel) oldLabel.remove();
            const cloneTypeLabel = document.createElement("div");
            cloneTypeLabel.className = "breaker-type-label type-" + b.type;
            cloneTypeLabel.textContent =
              b.type === "Standard" ? "STD."
              : b.type === "Tandem" ? "TAND"
              : String(b.type).toUpperCase();
            clone.appendChild(cloneTypeLabel);

            ns.appendChild(clone);
            ns.onclick = null;
            ns.style.pointerEvents = "none";
          }
        }
      }

      changesMade = false;
      autosaveSecondsLeft = 30;
      updateAutosaveText();
    }

    function clearSavedPanel() {
      if (confirm("Delete saved panel data?")) {
        localStorage.removeItem("breakerPanelData");
        alert("Saved panel data cleared.");
      }
    }

    function exportPanelJSON() {
      const saved = localStorage.getItem("breakerPanelData");
      if (!saved) { alert("No saved panel found. Save first to export."); return; }
      const blob = new Blob([saved], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "breaker_panel.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importPanelJSON() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          localStorage.setItem("breakerPanelData", ev.target.result);
          loadPanel();
        };
        reader.readAsText(file);
      };
      input.click();
    }

    /* ----------------- Export PNG (with trim + small margin; includes header/footer) ----------------- */

    async function exportPanelPNG() {
      try {
        // Hide any open modal UIs from capture
        const prevB = breakerDialog.style.display, prevM = mainDialog.style.display;
        const prevH = headerDialog.style.display, prevF = footerDialog.style.display;
        breakerDialog.style.display = "none";
        mainDialog.style.display = "none";
        headerDialog.style.display = "none";
        footerDialog.style.display = "none";

        // Switch to display-only mode for clean header/footer
        document.body.classList.add("exporting");

        const containerEl = document.getElementById("export-container");

        // Ensure header/footer display text is updated
        updateHeaderDisplay();
        updateFooterDisplay();

        const canvas = await html2canvas(containerEl, { scale: 4, backgroundColor: null });

        // Restore UI state
        document.body.classList.remove("exporting");
        breakerDialog.style.display = prevB;
        mainDialog.style.display = prevM;
        headerDialog.style.display = prevH;
        footerDialog.style.display = prevF;

        // Tight-crop by non-transparent pixels
        const ctx = canvas.getContext("2d");
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = imgData.data;

        let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;

        for (let y = 0; y < canvas.height; y++) {
          for (let x = 0; x < canvas.width; x++) {
            const idx = (y * canvas.width + x) * 4;
            if (pixels[idx + 3] > 0) { // alpha > 0
              if (x < minX) minX = x;
              if (x > maxX) maxX = x;
              if (y < minY) minY = y;
              if (y > maxY) maxY = y;
            }
          }
        }

        const cropW = Math.max(1, maxX - minX + 1);
        const cropH = Math.max(1, maxY - minY + 1);

        // Add a small uniform margin (e.g., 20px at export scale)
        const margin = 20 * 4; // scale=4
        const outW = cropW + margin * 2;
        const outH = cropH + margin * 2;

        const croppedCanvas = document.createElement("canvas");
        croppedCanvas.width = outW;
        croppedCanvas.height = outH;
        const croppedCtx = croppedCanvas.getContext("2d");

        croppedCtx.clearRect(0,0,outW,outH);
        croppedCtx.drawImage(canvas, minX, minY, cropW, cropH, margin, margin, cropW, cropH);

        const pngData = croppedCanvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = pngData;
        a.download = "breaker_panel.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (err) {
        alert("Failed to generate PNG: " + err.message);
      }
    }

    updateHeaderDisplay();
    updateFooterDisplay();
    updateAutosaveText();
  </script>
<script defer="defer" src="index_files/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;version&quot;:&quot;2024.11.0&quot;,&quot;token&quot;:&quot;3ff506332a5648c5b74d45824b087be9&quot;,&quot;r&quot;:1,&quot;server_timing&quot;:{&quot;name&quot;:{&quot;cfCacheStatus&quot;:true,&quot;cfEdge&quot;:true,&quot;cfExtPri&quot;:true,&quot;cfL4&quot;:true,&quot;cfOrigin&quot;:true,&quot;cfSpeedBrain&quot;:true},&quot;location_startswith&quot;:null}}" crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bce37c9f82efc4e',t:'MTc2ODIzNzMwOA=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><iframe height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: medium; visibility: hidden;"></iframe>

</body></html>